<div class="player-layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>ConteÃºdo do Curso</h3>
            <div class="progress-info">
                <span class="lesson-count">{{ completedLessons().length }}/{{ getTotalLessons() }} aulas</span>
                <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="getProgress()"></div>
                </div>
            </div>
        </div>

        <div class="modules-list">
            @for (module of course()?.modules; track module.id; let modIdx = $index) {
            <div class="module-group">
                <div class="module-header">
                    <span class="module-number">{{ modIdx + 1 }}</span>
                    {{ module.title }}
                </div>

                @for (lesson of module.lessons; track lesson.id) {
                <div class="lesson-item" [class.active]="currentLesson()?.id === lesson.id"
                    [class.completed]="isLessonCompleted(lesson.id)" (click)="selectLesson(lesson)">
                    <div class="lesson-icon">
                        <span nz-icon [nzType]="getLessonIcon(lesson)"
                            [class.completed-icon]="isLessonCompleted(lesson.id)"></span>
                    </div>
                    <div class="lesson-details">
                        <span class="lesson-name">{{ lesson.title }}</span>
                        <span class="lesson-type">{{ getTypeLabel(lesson.contentType) }}</span>
                    </div>
                    <span class="lesson-time">{{ lesson.duration }}</span>
                </div>
                }
            </div>
            }
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- Video/Header Area -->
        <div class="content-header" [class.has-video]="currentVideoUrl()">
            @if (currentVideoUrl()) {
            <div class="video-wrapper">
                <iframe [src]="currentVideoUrl()" allowfullscreen></iframe>
            </div>
            } @else {
            <div class="text-header">
                <span class="lesson-badge">{{ getTypeLabel(currentLesson()?.contentType) }}</span>
                <h1>{{ currentLesson()?.title }}</h1>
            </div>
            }
        </div>

        <!-- Content Body -->
        <div class="content-body">
            <!-- Lesson Description -->
            @if (currentLesson()?.description) {
            <div class="lesson-description">
                <p>{{ currentLesson()?.description }}</p>
            </div>
            }

            <!-- For text or mixed content -->
            @if (currentLesson()?.textContent) {
            <div class="text-content" [innerHTML]="currentLesson()?.textContent"></div>
            }

            <!-- Steps Checklist (Procedure Steps) -->
            @if (currentLesson()?.procedureSteps?.length) {
            <div class="steps-section">
                <h3 class="section-title">
                    <span nz-icon nzType="check-circle"></span>
                    Passo a Passo
                </h3>
                <div class="steps-list">
                    @for(step of currentLesson()?.procedureSteps; track step.step; let i = $index) {
                    <div class="step-item" [class.completed]="step.isCompleted">
                        <label nz-checkbox [ngModel]="step.isCompleted" (ngModelChange)="toggleStep(step)">
                            <span class="step-number">{{ step.step }}</span>
                            <span class="step-text">{{ step.description }}</span>
                        </label>
                        @if (step.tips?.length) {
                        <div class="step-tips">
                            @for (tip of step.tips; track tip) {
                            <span class="tip">ðŸ’¡ {{ tip }}</span>
                            }
                        </div>
                        }
                    </div>
                    }
                </div>
            </div>
            }

            <!-- Supplementary Material -->
            @if (currentLesson()?.supplementaryMaterial?.length) {
            <div class="supplementary-section">
                <h3 class="section-title">
                    <span nz-icon nzType="file-pdf"></span>
                    Material Complementar
                </h3>
                <div class="materials-list">
                    @for (material of currentLesson()?.supplementaryMaterial; track material) {
                    <a class="material-link" [href]="material" target="_blank">
                        <span nz-icon nzType="download"></span>
                        {{ material }}
                    </a>
                    }
                </div>
            </div>
            }

            <!-- Quiz Section -->
            @if (currentLesson()?.quiz?.questions?.length) {
            <div class="quiz-section">
                <h3 class="section-title">
                    <span nz-icon nzType="question-circle"></span>
                    Quiz - Teste seus conhecimentos
                </h3>

                @if (!quizSubmitted()) {
                <!-- Quiz Questions -->
                <div class="quiz-questions">
                    @for (question of currentLesson()!.quiz!.questions; track question.id; let qIdx = $index) {
                    <div class="quiz-question">
                        <p class="question-text">{{ qIdx + 1 }}. {{ question.question }}</p>
                        <div class="options-list">
                            @for (option of question.options; track option; let optIdx = $index) {
                            <div class="option-item" [class.selected]="quizAnswers()[question.id] === optIdx"
                                (click)="selectQuizAnswer(question.id, optIdx)">
                                <input type="radio" [name]="'q-' + question.id" [value]="optIdx"
                                    [checked]="quizAnswers()[question.id] === optIdx">
                                <span class="option-text">{{ option }}</span>
                            </div>
                            }
                        </div>
                    </div>
                    }
                </div>

                <button nz-button nzType="primary" nzSize="large" class="submit-quiz-btn" (click)="submitQuiz()"
                    [disabled]="!allQuestionsAnswered()">
                    <span nz-icon nzType="check-circle"></span>
                    Verificar Respostas
                </button>
                } @else {
                <!-- Quiz Results -->
                <div class="quiz-results">
                    <div class="result-header" [class.passed]="quizPassed()" [class.failed]="!quizPassed()">
                        @if (quizPassed()) {
                        <span class="result-icon">ðŸŽ‰</span>
                        <h4>ParabÃ©ns! VocÃª passou!</h4>
                        } @else {
                        <span class="result-icon">ðŸ“š</span>
                        <h4>Continue estudando!</h4>
                        }
                        <p class="score">VocÃª acertou {{ quizScore() }}% ({{ getCorrectCount() }}/{{
                            currentLesson()!.quiz!.questions.length }})</p>
                    </div>

                    <!-- Show answers with feedback -->
                    <div class="quiz-feedback">
                        @for (question of currentLesson()!.quiz!.questions; track question.id; let qIdx = $index) {
                        <div class="feedback-item"
                            [class.correct]="quizAnswers()[question.id] === question.correctOptionIndex"
                            [class.incorrect]="quizAnswers()[question.id] !== question.correctOptionIndex">
                            <div class="feedback-header">
                                <span class="feedback-icon">
                                    @if (quizAnswers()[question.id] === question.correctOptionIndex) {
                                    âœ“
                                    } @else {
                                    âœ—
                                    }
                                </span>
                                <span class="question-num">QuestÃ£o {{ qIdx + 1 }}</span>
                            </div>
                            <p class="question-text">{{ question.question }}</p>
                            <div class="answer-info">
                                @if (quizAnswers()[question.id] !== question.correctOptionIndex) {
                                <p class="your-answer">Sua resposta: <strong>{{
                                        question.options[quizAnswers()[question.id]] }}</strong></p>
                                }
                                <p class="correct-answer">Resposta correta: <strong>{{
                                        question.options[question.correctOptionIndex] }}</strong></p>
                            </div>
                        </div>
                        }
                    </div>

                    @if (!quizPassed()) {
                    <button nz-button nzType="default" nzSize="large" class="retry-btn" (click)="retryQuiz()">
                        <span nz-icon nzType="reload"></span>
                        Tentar Novamente
                    </button>
                    }
                </div>
                }
            </div>
            }

            <!-- Action Bar -->
            <div class="action-bar">
                <button nz-button nzType="default" (click)="previousLesson()" [disabled]="!hasPrevious()">
                    <span nz-icon nzType="arrow-left"></span> Anterior
                </button>

                @if (isLessonCompleted(currentLesson()?.id || '')) {
                <button nz-button nzType="default" (click)="nextLesson()" [disabled]="!hasNext()">
                    PrÃ³xima <span nz-icon nzType="arrow-right"></span>
                </button>
                } @else {
                <button nz-button nzType="primary" (click)="markAsCompleted()">
                    <span nz-icon nzType="check"></span> Concluir e AvanÃ§ar
                </button>
                }
            </div>
        </div>
    </main>
</div>

<!-- Review Modal -->
<app-course-review [courseId]="course()?._id || ''" [courseName]="course()?.title || ''" [isVisible]="showReviewModal()"
    (visibleChange)="closeReviewModal()" (reviewSubmitted)="onReviewSubmitted()">
</app-course-review>