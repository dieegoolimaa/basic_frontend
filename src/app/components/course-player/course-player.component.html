<div class="player-layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>Conte√∫do do Curso</h3>
            <div class="progress-info">
                <span class="lesson-count">{{ completedLessons().length }}/{{ getTotalLessons() }} aulas</span>
                <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="getProgress()"></div>
                </div>
            </div>
        </div>

        <div class="modules-list">
            @for (module of course()?.modules; track module.id; let modIdx = $index) {
            <div class="module-group">
                <div class="module-header">
                    <span class="module-number">{{ modIdx + 1 }}</span>
                    {{ module.title }}
                </div>

                @for (lesson of module.lessons; track lesson.id) {
                <div class="lesson-item" [class.active]="currentLesson()?.id === lesson.id"
                    [class.completed]="isLessonCompleted(lesson.id)" (click)="selectLesson(lesson)">
                    <div class="lesson-icon">
                        <span nz-icon [nzType]="getLessonIcon(lesson)"
                            [class.completed-icon]="isLessonCompleted(lesson.id)"></span>
                    </div>
                    <div class="lesson-details">
                        <span class="lesson-name">{{ lesson.title }}</span>
                        <span class="lesson-type">{{ getTypeLabel(lesson.contentType) }}</span>
                    </div>
                    <span class="lesson-time">{{ lesson.duration }}</span>
                </div>
                }
            </div>
            }
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- Video/Header Area -->
        <div class="content-header" [class.has-video]="currentVideoUrl()">
            @if (currentVideoUrl()) {
            <div class="video-wrapper">
                <iframe [src]="currentVideoUrl()" allowfullscreen></iframe>
            </div>
            } @else {
            <div class="text-header">
                <span class="lesson-badge">{{ getTypeLabel(currentLesson()?.contentType) }}</span>
                <h1>{{ currentLesson()?.title }}</h1>
            </div>
            }
        </div>

        <!-- Content Body -->
        <div class="content-body">
            <!-- Lesson Description -->
            @if (currentLesson()?.description) {
            <div class="lesson-description">
                <p>{{ currentLesson()?.description }}</p>
            </div>
            }

            <!-- For text or mixed content -->
            @if (currentLesson()?.textContent) {
            <div class="text-content" [innerHTML]="currentLesson()?.textContent"></div>
            }

            <!-- Steps Checklist (Procedure Steps) -->
            @if (currentLesson()?.procedureSteps?.length) {
            <div class="steps-section">
                <h3 class="section-title">
                    <span nz-icon nzType="check-circle"></span>
                    Passo a Passo
                </h3>
                <div class="steps-list">
                    @for(step of currentLesson()?.procedureSteps; track step.step; let i = $index) {
                    <div class="step-item" [class.completed]="step.isCompleted">
                        <label nz-checkbox [ngModel]="step.isCompleted" (ngModelChange)="toggleStep(step)">
                            <span class="step-number">{{ step.step }}</span>
                            <span class="step-text">{{ step.description }}</span>
                        </label>
                        @if (step.tips?.length) {
                        <div class="step-tips">
                            @for (tip of step.tips; track tip) {
                            <span class="tip">üí° {{ tip }}</span>
                            }
                        </div>
                        }
                    </div>
                    }
                </div>
            </div>
            }

            <!-- Supplementary Material -->
            @if (currentLesson()?.supplementaryMaterial?.length) {
            <div class="supplementary-section">
                <h3 class="section-title">
                    <span nz-icon nzType="file-pdf"></span>
                    Material Complementar
                </h3>
                <div class="materials-list">
                    @for (material of currentLesson()?.supplementaryMaterial; track material) {
                    <a class="material-link" [href]="material" target="_blank">
                        <span nz-icon nzType="download"></span>
                        {{ material }}
                    </a>
                    }
                </div>
            </div>
            }

            <!-- Action Bar -->
            <div class="action-bar">
                <button nz-button nzType="default" (click)="previousLesson()" [disabled]="!hasPrevious()">
                    <span nz-icon nzType="arrow-left"></span> Anterior
                </button>

                @if (isLessonCompleted(currentLesson()?.id || '')) {
                <button nz-button nzType="default" (click)="nextLesson()" [disabled]="!hasNext()">
                    Pr√≥xima <span nz-icon nzType="arrow-right"></span>
                </button>
                } @else {
                <button nz-button nzType="primary" (click)="markAsCompleted()">
                    <span nz-icon nzType="check"></span> Concluir e Avan√ßar
                </button>
                }
            </div>
        </div>
    </main>
</div>

<!-- Review Modal -->
<app-course-review [courseId]="course()?._id || ''" [courseName]="course()?.title || ''" [isVisible]="showReviewModal()"
    (visibleChange)="closeReviewModal()" (reviewSubmitted)="onReviewSubmitted()">
</app-course-review>